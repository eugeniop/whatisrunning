<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Train Admin</title>
<style>
*{box-sizing:border-box}
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  margin:0;
  background:#f6f7fb;
  color:#1f2933;
}
.page{
  max-width:1100px;
  margin:0 auto;
  padding:18px 18px 32px;
}
h1{margin:0 0 10px;font-size:28px}
h2{margin:0 0 6px;font-size:22px}
.row{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:14px 16px;
  align-items:end;
}
label{display:block;font-size:14px;color:#344152;margin:10px 0 6px;font-weight:650}
input,select,textarea,button{
  width:100%;
  padding:11px 12px;
  font-size:16px;
  border-radius:10px;
  border:1px solid #d4d8e0;
}
input:focus,select:focus,textarea:focus{outline:2px solid #8ab5ff;outline-offset:1px;border-color:#8ab5ff}
textarea{min-height:82px;resize:vertical}
.actions{
  display:flex;
  gap:10px;
  margin-top:12px;
  flex-wrap:wrap;
}
button{
  cursor:pointer;
  border:none;
  background:#0f60d8;
  color:white;
  font-weight:700;
  box-shadow:0 6px 16px rgba(15,96,216,.18);
  transition:.1s ease;
}
button[type="button"]{background:#e4e7ee;color:#1f2933;box-shadow:none}
button:hover{transform:translateY(-1px)}
.card{
  border:1px solid #d8dce5;
  border-radius:14px;
  padding:14px;
  margin-top:14px;
  background:white;
  box-shadow:0 10px 24px rgba(0,0,0,.04);
}
.small{color:#5b6573;font-size:13px}
.hint{margin-top:6px;font-size:13px;color:#5b6573}
.list{margin-top:20px}
.item{
  display:grid;
  grid-template-columns:1fr auto;
  align-items:center;
  gap:12px;
  border:1px solid #e2e5ed;
  border-radius:12px;
  padding:12px;
  margin:10px 0;
  background:#f9fafc;
}
.item .meta{display:flex;flex-direction:column;gap:4px}
.item .tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:2px}
.item button{width:120px}
.badge{
  display:inline-block;
  font-size:13px;
  padding:4px 8px;
  border-radius:999px;
  background:#eef2fb;
  color:#33405a;
  border:1px solid #dfe3ee;
  width:max-content;
}
.list .small{margin-bottom:6px}
@media(max-width:960px){
  .page{padding:18px 14px 28px}
  .item{grid-template-columns:1fr;align-items:flex-start}
  .item button{width:100%}
}
</style>
</head>
<body>
<div class="page">

  <h1>Train Admin</h1>
  <div class="small">Add a train as ‚Äúrunning‚Äù. Public display updates instantly.</div>

  <div class="card">
    <div class="row">
      <div>
        <label for="name">Train name</label>
        <input id="name" placeholder="BR 01 Express" />
      </div>
      <div>
        <label for="railway">Railway</label>
        <input id="railway" placeholder="Deutsche Bundesbahn" />
      </div>
    </div>

    <div class="row">
      <div>
        <label for="country">Country (emoji flag)</label>
        <input id="country" list="flagOptions" placeholder="üá©üá™" />
        <datalist id="flagOptions">
          <option value="üá©üá™">Germany</option>
          <option value="üá∫üá∏">United States</option>
          <option value="üá¨üáß">United Kingdom</option>
          <option value="üá´üá∑">France</option>
          <option value="üá™üá∏">Spain</option>
          <option value="üáÆüáπ">Italy</option>
          <option value="üá®üá≠">Switzerland</option>
          <option value="üá≥üá±">Netherlands</option>
          <option value="üáßüá™">Belgium</option>
          <option value="üá®üá¶">Canada</option>
          <option value="üá¶üáπ">Austria</option>
          <option value="üáµüá±">Poland</option>
          <option value="üá®üáø">Czechia</option>
          <option value="üá∏üá™">Sweden</option>
          <option value="üá´üáÆ">Finland</option>
          <option value="üá≥üá¥">Norway</option>
          <option value="üáØüáµ">Japan</option>
          <option value="üá®üá≥">China</option>
          <option value="üá¶üá∫">Australia</option>
          <option value="üá≥üáø">New Zealand</option>
          <option value="üáßüá∑">Brazil</option>
          <option value="üá≤üáΩ">Mexico</option>
          <option value="üáøüá¶">South Africa</option>
          <option value="üáÆüá≥">India</option>
          <option value="üè≥Ô∏è">Other / Custom</option>
        </datalist>
        <div class="hint">Choose a flag or type any emoji or string.</div>
      </div>
      <div>
        <label for="years">Years (e.g. 1950 or 1950‚Äì1960)</label>
        <input id="years" placeholder="1950‚Äì1960" />
      </div>
    </div>

    <div class="row">
      <div>
        <label for="power">Power</label>
        <select id="power">
          <option>Steam</option>
          <option>Diesel</option>
          <option>Electric</option>
        </select>
      </div>
      <div>
        <label for="powerType">Power type</label>
        <select id="powerType">
          <option>AC</option>
          <option>DC</option>
          <option>Digital</option>
        </select>
      </div>
      <div>
        <label for="trainType">Train type</label>
        <select id="trainType">
          <option>Passenger</option>
          <option>Freight</option>
          <option>Special</option>
          <option>Mixed</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label for="location">Location</label>
        <select id="location">
          <option>Upper loop</option>
          <option>Lower loop 1</option>
          <option>Lower loop 2</option>
        </select>
      </div>
      <div>
        <label for="numberOfCars">Number of cars (0-100)</label>
        <input id="numberOfCars" type="number" min="0" max="100" step="1" value="0" />
      </div>
      <div>
        <label for="owner">Owner (stored only; not shown publicly)</label>
        <input id="owner" placeholder="Member name" />
      </div>
    </div>

    <label for="notes">Notes</label>
    <textarea id="notes" placeholder="8-car express, manifest freight, etc."></textarea>

    <div class="actions">
      <button onclick="addTrain()">Add / Set Running</button>
      <button onclick="clearForm()" type="button">Clear</button>
    </div>

    <div class="small" id="status"></div>
  </div>

  <div class="list">
    <h2>Currently Running</h2>
    <div class="small">Shows live and mirrors the visitor display.</div>
    <div id="running"></div>
  </div>
</div>

<script>
async function api(path, opts){
  const res = await fetch(path, { headers:{ "Content-Type":"application/json" }, ...opts });
  const data = await res.json().catch(()=> ({}));
  if (!res.ok) throw new Error(data.error || "Request failed");
  return data;
}

function val(id){ return document.getElementById(id).value.trim(); }

async function refresh(){
  const data = await api("/api/running");
  const root = document.getElementById("running");
  if (!data.trains.length){
    root.innerHTML = `<div class="small">No running trains.</div>`;
    return;
  }
  root.innerHTML = data.trains.map(t => `
    <div class="item">
      <div class="meta">
        <strong>${escapeHtml(t.country)} ${escapeHtml(t.name)}</strong>
        <span class="small">${escapeHtml(t.railway)}</span>
        <div class="tags">
          <span class="badge">${escapeHtml(t.power)}</span>
          <span class="badge">${escapeHtml(t.trainType)}</span>
          <span class="badge">${escapeHtml(t.years)}</span>
          <span class="badge">üöÉ ${escapeHtml(t.numberOfCars)} cars</span>
          <span class="badge">üîå ${escapeHtml(t.powerType)}</span>
          <span class="badge">üìç ${escapeHtml(t.location)}</span>
        </div>
      </div>
      <button onclick="stopTrain('${t.id}')">Stop</button>
    </div>
  `).join("");
}

async function addTrain(){
  const body = {
    name: val("name"),
    railway: val("railway"),
    country: val("country"),
    power: val("power"),
    powerType: val("powerType"),
    trainType: val("trainType"),
    numberOfCars: Number(document.getElementById("numberOfCars").value),
    years: val("years"),
    notes: document.getElementById("notes").value.trim(),
    owner: val("owner"),
    location: val("location")
  };

  const status = document.getElementById("status");
  status.textContent = "Saving‚Ä¶";
  try{
    await api("/api/running", { method:"POST", body: JSON.stringify(body) });
    status.textContent = "Saved. Display updated.";
    await refresh();
  }catch(e){
    status.textContent = "Error: " + e.message;
  }
}

async function stopTrain(id){
  if (!confirm("Mark this train as stopped?")) return;
  try{
    await api(`/api/running/${id}`, { method:"DELETE" });
    await refresh();
  }catch(e){
    alert(e.message);
  }
}

function clearForm(){
  ["name","railway","country","years","owner"].forEach(id => document.getElementById(id).value = "");
  document.getElementById("numberOfCars").value = "0";
  document.getElementById("powerType").value = "AC";
  document.getElementById("notes").value = "";
  document.getElementById("status").textContent = "";
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

refresh();
</script>

</body>
</html>
